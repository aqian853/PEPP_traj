library(glmnet)
library(haven)
library(dplyr)

## Load dataset
PEPP_data <- read_sav("PEPP_2024-12-12-IDmatched.sav")

## The definition of binary output is as follows: 
# YES - CDSS_0 >= 5, CDSS_18 < 5
# NO - CDSS_0 >= 5, CDSS_18 >= 5

# Filter the full data
PEPP_filtered <- PEPP_data %>%
  filter(CDS_0 >= 5) %>%
  mutate(Response_bin = ifelse(CDS_18 < 5, 1, 
                               ifelse(CDS_18 >= 5, 0, NA))) %>%
  filter(!is.na(Response_bin))  # Remove rows with NA in the outcome

# Prepare predictor matrix using only the filtered data
predictor_for_CDSS <- PEPP_filtered %>%
  select(contains("ageentry"), contains("gender"), contains("SANS_0"))

x <- model.matrix(~ ., data = predictor_for_CDSS)[, -1]  # numeric matrix
y <- PEPP_filtered$Response_bin                          # numeric vector (0/1)

# Fit the elastic net logistic regression
cv_model <- cv.glmnet(x, y, family = "binomial", alpha = 1, type.measure = "class")

# Optional: Plot cross-validation error
plot(cv_model)

# View coefficients at best lambda
coef(cv_model, s = "lambda.min")
